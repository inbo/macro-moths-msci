---
title: "Calculate MSCI for specific traits and combinations"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
opts_knit$set(root.dir = here::here())

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(stats::lag)
conflicted::conflicts_prefer(brms::ar)
conflicted::conflicts_prefer(brms::dstudent_t)
conflicted::conflicts_prefer(brms::pstudent_t)
conflicted::conflicts_prefer(brms::qstudent_t)
conflicted::conflicts_prefer(brms::rstudent_t)

# Packages
library(tidyverse)
library(brms)
library(tidybayes)

# Source
source(here("source", "summarise_brms_models.R"))
```

# Goal

Fit models and calculate MSCI for specific trait combinations.

# Load data

```{r}
data_path <- file.path("data", "processed")

species_traits_final <- read_csv(file.path(data_path,
                                           "prop_data_per_trait.csv"))
```

# Automatisation

-   make a list with each trait (combination)
-   `lapply()` to create list of filtered dataframes
-   visualise and filter on group sizes
-   `lapply()` to create formula list
-   fit models in for loop
-   check MCMC convergence in for loop
-   check model fit in for loop
-   ...

# Data preparation
## Trait combinations

We consider a number of trait combinations.

```{r}
trait_combinations <- list(
  c("Biotope", "Phagy"),
  c("Biotope", "EllenbergN"),
  c("colourVariation", "Size"),
  c("Activity", "nGenerations"),
  c("OverwinteringStage", "nGenerations"),
  c("Phagy", "LarvalFoodSource2"),
  c("Phagy", "EllenbergN"),
  c("Phagy", "nGenerations"),
  c("Phagy", "Size"),
  c("Phagy", "TempHum"),
  c("LarvalFoodSource2", "EllenbergN"),
  c("EllenbergN", "TempHum"),
  c("nGenerations", "Distribution"),
  c("nGenerations", "Size"),
  c("nGenerations", "TempHum"),
  c("Distribution", "TempHum"),
  c("Size", "TempHum")
)
trait_combinations
```


## Filter dataframes per trait combination

We create a list of dataframes per trait combination.

```{r}
trait_df_list <- lapply(trait_combinations, function(combo) {
  if (length(combo) == 2) {
    row <- combo[1]
    column <- combo[2]
    out <- species_traits_final %>%
      filter(trait_name %in% combo) %>%
      pivot_wider(
        id_cols = c("species_nl", "species_new", "n_grids", "period",
                    "sum_per_period"),
        names_from = "trait_name",
        values_from = "trait_value"
      ) %>%
      # Fill in missing trait values for species that occur twice
      group_by(species_nl) %>%
      arrange(species_nl, species_new, !!sym(row), !!sym(column)) %>%
      mutate(
        "{row}" := ifelse(is.na(!!sym(row)), # nolint: object_name_linter.
          first(!!sym(row)), !!sym(row)
        ),
        "{column}" := ifelse(is.na(!!sym(column)), # nolint: object_name_linter.
          first(!!sym(column)), !!sym(column)
        )
      ) %>%
      ungroup() %>%
      # How many species per trait combination?
      group_by_at(c("period", combo)) %>%
      mutate(n_species = n()) %>%
      ungroup() %>%
      select(-species_nl) %>%
      mutate(species_nl = species_new) %>%
      select(-species_new) %>% 
      select_at(c("species_nl", "n_grids", "period", "sum_per_period", combo,
                  "n_species"))
  } else if (length(combo) == 1) {
    species_traits_final %>%
      filter(trait_name == combo) %>%
      pivot_wider(
        id_cols = c("species_nl", "species_new", "n_grids", "period",
                    "sum_per_period"),
        names_from = "trait_name",
        values_from = "trait_value"
      ) %>%
      # How many species per trait combination?
      group_by_at(c("period", combo)) %>%
      mutate(n_species = n()) %>%
      ungroup() %>%
      select(-species_nl) %>%
      mutate(species_nl = species_new) %>%
      select(-species_new) %>% 
      select_at(c("species_nl", "n_grids", "period", "sum_per_period", combo,
                  "n_species"))
  } else {
    stop("Function not implemented for combinations of more than 2 traits.", 
         call. = FALSE)
  }
  return(out)
})

names_trait_df_list <- sapply(trait_combinations, function(combo) {
  paste(combo, collapse = "_")
})

names(trait_df_list) <- names_trait_df_list
```


