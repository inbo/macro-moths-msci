---
title: "Calculate MSCI for resident species"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
opts_knit$set(root.dir = here::here())

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(stats::lag)
conflicted::conflicts_prefer(brms::ar)
conflicted::conflicts_prefer(brms::dstudent_t)
conflicted::conflicts_prefer(brms::pstudent_t)
conflicted::conflicts_prefer(brms::qstudent_t)
conflicted::conflicts_prefer(brms::rstudent_t)

# Packages
library(tidyverse)
library(brms)
library(tidybayes)

# Source
source(here("source", "summarise_brms_models.R"))
source(here("source", "set_priors_brms.R"))

# Seed
seed <- 123
```

# Goal

Fit models and calculate MSCI for all resident species.

# Load data

```{r load-data}
data_path <- file.path("data", "processed")

species_traits_final <- read_csv(file.path(data_path,
                                           "prop_data_per_trait.csv"))
```

# Data preparation

```{r data-prep}
species_df_raw <- species_traits_final %>%
  filter(trait_value == "Resident") %>%
  select(species_nl, n_grids, period, sum_per_period) %>%
  mutate(species_nl = factor(species_nl))
```

In total we have `r length(unique(species_df_raw$species_nl))` resident species.
The following species have disapeared or emerged.
We cannot calculate a species change index.

```{r}
species_df_raw %>%
  pivot_wider(id_cols = species_nl,
              names_from = period,
              values_from = n_grids) %>%
  filter(p1980_2012 == 0 | p2013_2022 == 0) %>%
  kable()
```

```{r}
inf_species <- species_df_raw %>%
  pivot_wider(id_cols = species_nl,
              names_from = period,
              values_from = n_grids) %>%
  filter(p1980_2012 == 0 | p2013_2022 == 0) %>%
  pull(species_nl) %>%
  as.vector()

species_df <- species_df_raw %>%
  filter(!species_nl %in% inf_species) %>%
  mutate(species_nl = factor(species_nl))
```


# Fit model

```{r cache-dir}
# create cache directory if not yet available
dir.create(here("source", "brms_cache"), FALSE)
```

```{r mcmc-params}
# MCMC parameters
nchains <- 3 # number of chains
niter <- 20000 # number of iterations (incl. burn-in)
burnin <- niter / 5 # number of initial samples to discard (burn-in)
nparallel <- nchains # number of cores used for parallel computing
thinning <- 8
```

```{r fit-model}
fit_msci_species <- brm(
  bf(n_grids ~ period * species_nl + offset(log(sum_per_period))),
  data = species_df, family = poisson(),
  chains = nchains, warmup = burnin, iter = niter, cores = nparallel,
  file = "source/brms_cache/fit_msci_species",
  file_refit = "on_change"
)
```


# Model convergence

We check MCMC convergence based on posterior densities, trace plots and the potential scale reduction factors ($\hat{R}$) for each parameter in each model.

```{r trace-plots}
plot(fit_msci_species, ask = FALSE)
```

```{r rhat}
rhat_list <- get_rhats(list(species_model = fit_msci_species))
show_rhat(do.call(rbind.data.frame, rhat_list))
```

Convergence is good.

# Checking model fit

We check model fit based on posterior predictive checks where we compare the observed outcome to simulated datasets from the posterior predictive distribution.

```{r}
pp_check(fit_msci_species,
  type = "dens_overlay_grouped", ndraws = 100,
  group = "period"
)
```

Model fit is good.


# Results



