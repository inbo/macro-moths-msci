---
title: "Create figures for research paper"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
opts_knit$set(root.dir = here::here())

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
library(INBOtheme)
theme_set(theme_inbo(transparent = TRUE))
```

# Goal

Create nice figures for the research paper.

# Load data

```{r load-data}
data_path <- file.path("output", "r_objects")

msci_draw_list_log_raw <- readRDS(file.path(data_path,
                                            "msci_draw_list_log.rds"))
```

# Prepare data

```{r}
msci_draw_list_log <- lapply(msci_draw_list_log_raw, function(df) {
  df %>%
    mutate(label = paste0(trait_value, "\n", "(n = ", n_species, ")"),
           label = reorder(label, msci.median,  decreasing = FALSE))
  })
```

# MSCI figures
## Set general themes and functions

```{r}
index_labels <- function(x) {
  sprintf("%+.0f%%", 100 * (exp(x) - 1))
}


index_breaks <- function(x) {
  z <- 1 - c(
    4 / 5, 3 / 4, 2 / 3, 1 / 2, 1 / 3, 1 / 5
  )
  z <- log(sort(z))
  c(z, 0, -z)
}

minor_breaks <- function(x) {
  breaks <- unique(abs(index_breaks(x)))
  out <- vector(length = length(breaks) - 1)
  i <- 1
  while (i < length(breaks)) {
    out[i] <- mean(c(breaks[i], breaks[i + 1]))
    i <- i + 1
  }
  return(c(-out, out))
}

index_breaks_rev <- function(x) {
  exp(index_breaks(x))
}

index_labels_rev <- function(x, digits = 2) {
  format(round(exp(index_breaks(x)), digits), nsmall = digits)
}
```

```{r}
min_threshold <- log(0.8)
max_threshold <- log(1.25)
```


## Biotope

```{r}
p_biotope <- msci_draw_list_log$Biotope %>%
  ggplot(aes(y = label)) +
    geom_violin(aes(x = msci.draw, fill = trend_coarse),
                colour = alpha("white", 0)) +
    geom_vline(xintercept = 0, linetype = "longdash", colour = "black") +
    geom_vline(xintercept = c(min_threshold, max_threshold),
               linetype = "dotdash") +
    geom_errorbar(aes(xmin = msci.lower, xmax = msci.upper),
                  linewidth = 1, colour = "black", width = 0.1) +
    geom_point(aes(x = msci.median),
               size = 2.2, colour = "black") +
    scale_fill_manual(values =  c("chartreuse3",
                                  "gold",
                                  "firebrick1",
                                  "skyblue"),
                      drop = FALSE) +
    labs(y = "",
         x = "Multi-Species Change Index",
         fill = "Trend") +
    scale_x_continuous(breaks = index_breaks, labels = index_labels,
                       minor_breaks = minor_breaks,
                       limits = c(-log(2.4), log(2.4)),
                       sec.axis = sec_axis(~ exp(.),
                        breaks = index_breaks_rev(
                          msci_draw_list_log$Biotope$msci.draw
                          ),
                        labels = index_labels_rev(
                          msci_draw_list_log$Biotope$msci.draw
                          ),
                        name = "Proportional change")) +
    theme(
      legend.position = c(1, 0),
      legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white", color = "darkgrey"),
      legend.margin = margin(6, 6, 6, 6)
    )

p_biotope1 <- p_biotope +
  annotate("text", label = c("increase", "strong increase"),
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.3, 0.3),
           size = 2.6, hjust = "left") +
  annotate("segment",
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.4, 0.4),
           xend = c(0 + 0.1, max_threshold + 0.1), yend = c(0.4, 0.4),
           arrow = arrow(type = "closed", length = unit(0.005, "npc"))) +
  annotate("text", label = c("decrease", "strong decrease"),
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.3, 0.3),
           size = 2.6, hjust = "right") +
  annotate("segment",
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.4, 0.4),
           xend = c(0 - 0.1, min_threshold - 0.1), yend = c(0.4, 0.4),
           arrow = arrow(type = "closed", length = unit(0.005, "npc"))) +
  expand_limits(y = c(0.001, 0)) +
  theme(
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(size = 16)
  ) +
  theme(
    legend.key.size = unit(0.7, "cm"), # Change legend key size
    legend.key.height = unit(0.7, "cm"), # Change legend key height
    legend.key.width = unit(0.7, "cm"), # Change legend key width
    legend.title = element_text(size = 12), # Change legend title font size
    legend.text = element_text(size = 10) # Change legend text font size
  )

p_biotope1
```


```{r}
ggsave(file.path("media", "msci_biotope_conference.jpg"),
       p_biotope1,
       dpi = 300,
       width = 8,
       height = 8)
```


## Larval food source

We do not include trait value 'Diverse'.

```{r}
p_larvalfoodsource <- msci_draw_list_log$LarvalFoodSource %>%
  filter(trait_value != "Diverse") %>%
  ggplot(aes(y = label)) +
    geom_violin(aes(x = msci.draw, fill = trend_coarse),
                colour = alpha("white", 0)) +
    geom_vline(xintercept = 0, linetype = "longdash", colour = "black") +
    geom_vline(xintercept = c(min_threshold, max_threshold),
               linetype = "dotdash") +
    geom_errorbar(aes(xmin = msci.lower, xmax = msci.upper),
                  linewidth = 1, colour = "black", width = 0.1) +
    geom_point(aes(x = msci.median),
               size = 2.2, colour = "black") +
    scale_fill_manual(values =  c("chartreuse3",
                                  "gold",
                                  "firebrick1",
                                  "skyblue"),
                      drop = FALSE) +
    labs(y = "",
         x = "Multi-Species Change Index",
         fill = "Trend") +
    scale_x_continuous(breaks = index_breaks, labels = index_labels,
                       minor_breaks = minor_breaks,
                       limits = c(-log(2.4), log(2.4)),
                       sec.axis = sec_axis(~ exp(.),
                        breaks = index_breaks_rev(
                          msci_draw_list_log$LarvalFoodSource$msci.draw
                          ),
                        labels = index_labels_rev(
                          msci_draw_list_log$LarvalFoodSource$msci.draw
                          ),
                        name = "Proportional change")) +
  theme(
    legend.position = c(1, 0),
    legend.justification = c(1, 0),
    legend.background = element_rect(fill = "white", color = "darkgrey"),
    legend.margin = margin(6, 6, 6, 6)
  )

p_larvalfoodsource1 <- p_larvalfoodsource +
  annotate("text", label = c("increase", "strong increase"),
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.25, 0.25),
           size = 2.5, hjust = "left") +
  annotate("segment",
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.35, 0.35),
           xend = c(0 + 0.1, max_threshold + 0.1), yend = c(0.35, 0.35),
           arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
  annotate("text", label = c("decrease", "strong decrease"),
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.25, 0.25),
           size = 2.5, hjust = "right") +
  annotate("segment",
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.35, 0.35),
           xend = c(0 - 0.1, min_threshold - 0.1), yend = c(0.35, 0.35),
           arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
  expand_limits(y = c(0.001, 0)) +
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14)
  ) +
  theme(
    legend.key.size = unit(0.5, "cm"), # Change legend key size
    legend.key.height = unit(0.5, "cm"), # Change legend key height
    legend.key.width = unit(0.5, "cm"), # Change legend key width
    legend.title = element_text(size = 10), # Change legend title font size
    legend.text = element_text(size = 8) # Change legend text font size
  )

p_larvalfoodsource1
```


```{r}
ggsave(file.path("media", "msci_larvalfoodsource_conference.jpg"),
       p_larvalfoodsource1,
       dpi = 300,
       width = 8,
       height = 4)
```


## Larval food source

```{r}
p_overwinteringstage <- msci_draw_list_log$OverwinteringStage %>%
  ggplot(aes(y = label)) +
    geom_violin(aes(x = msci.draw, fill = trend_coarse),
                colour = alpha("white", 0)) +
    geom_vline(xintercept = 0, linetype = "longdash", colour = "black") +
    geom_vline(xintercept = c(min_threshold, max_threshold),
               linetype = "dotdash") +
    geom_errorbar(aes(xmin = msci.lower, xmax = msci.upper),
                  linewidth = 1, colour = "black", width = 0.1) +
    geom_point(aes(x = msci.median),
               size = 2.2, colour = "black") +
    scale_fill_manual(values =  c("chartreuse3",
                                  "gold",
                                  "firebrick1",
                                  "skyblue"),
                      drop = FALSE) +
    labs(y = "",
         x = "Multi-Species Change Index",
         fill = "Trend") +
    scale_x_continuous(breaks = index_breaks, labels = index_labels,
                       minor_breaks = minor_breaks,
                       limits = c(-log(2.4), log(2.4)),
                       sec.axis = sec_axis(~ exp(.),
                        breaks = index_breaks_rev(
                          msci_draw_list_log$OverwinteringStage$msci.draw
                          ),
                        labels = index_labels_rev(
                          msci_draw_list_log$OverwinteringStage$msci.draw
                          ),
                        name = "Proportional change")) +
  theme(
    legend.position = c(1, 0),
    legend.justification = c(1, 0),
    legend.background = element_rect(fill = "white", color = "darkgrey"),
    legend.margin = margin(6, 6, 6, 6)
  )

p_overwinteringstage1 <- p_overwinteringstage +
  annotate("text", label = c("increase", "strong increase"),
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.25, 0.25),
           size = 2.5, hjust = "left") +
  annotate("segment",
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.35, 0.35),
           xend = c(0 + 0.1, max_threshold + 0.1), yend = c(0.35, 0.35),
           arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
  annotate("text", label = c("decrease", "strong decrease"),
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.25, 0.25),
           size = 2.5, hjust = "right") +
  annotate("segment",
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.35, 0.35),
           xend = c(0 - 0.1, min_threshold - 0.1), yend = c(0.35, 0.35),
           arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
  expand_limits(y = c(0.001, 0)) +
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14)
  ) +
  theme(
    legend.key.size = unit(0.5, "cm"), # Change legend key size
    legend.key.height = unit(0.5, "cm"), # Change legend key height
    legend.key.width = unit(0.5, "cm"), # Change legend key width
    legend.title = element_text(size = 10), # Change legend title font size
    legend.text = element_text(size = 8) # Change legend text font size
  )

p_overwinteringstage1
```


```{r}
ggsave(file.path("media", "msci_overwinteringstage_conference.jpg"),
       p_overwinteringstage1,
       dpi = 300,
       width = 8,
       height = 4)
```


## Host plant specificity

```{r}
p_hostplantspecificity <- msci_draw_list_log$HostPlantSpecificity %>%
  ggplot(aes(y = label)) +
    geom_violin(aes(x = msci.draw, fill = trend_coarse),
                colour = alpha("white", 0)) +
    geom_vline(xintercept = 0, linetype = "longdash", colour = "black") +
    geom_vline(xintercept = c(min_threshold, max_threshold),
               linetype = "dotdash") +
    geom_errorbar(aes(xmin = msci.lower, xmax = msci.upper),
                  linewidth = 1, colour = "black", width = 0.1) +
    geom_point(aes(x = msci.median),
               size = 2.2, colour = "black") +
    scale_fill_manual(values =  c("chartreuse3",
                                  "gold",
                                  "firebrick1",
                                  "skyblue"),
                      drop = FALSE) +
    labs(y = "",
         x = "Multi-Species Change Index",
         fill = "Trend") +
    scale_x_continuous(breaks = index_breaks, labels = index_labels,
                       minor_breaks = minor_breaks,
                       limits = c(-log(2.4), log(2.4)),
                       sec.axis = sec_axis(~ exp(.),
                        breaks = index_breaks_rev(
                          msci_draw_list_log$HostPlantSpecificity$msci.draw
                          ),
                        labels = index_labels_rev(
                          msci_draw_list_log$HostPlantSpecificity$msci.draw
                          ),
                        name = "Proportional change")) +
  theme(
    legend.position = c(1, 0),
    legend.justification = c(1, 0),
    legend.background = element_rect(fill = "white", color = "darkgrey"),
    legend.margin = margin(6, 6, 6, 6)
  )

p_hostplantspecificity1 <- p_hostplantspecificity +
  annotate("text", label = c("increase", "strong increase"),
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.25, 0.25),
           size = 2.5, hjust = "left") +
  annotate("segment",
           x = c(0 + 0.02, max_threshold + 0.02), y = c(0.35, 0.35),
           xend = c(0 + 0.1, max_threshold + 0.1), yend = c(0.35, 0.35),
           arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
  annotate("text", label = c("decrease", "strong decrease"),
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.25, 0.25),
           size = 2.5, hjust = "right") +
  annotate("segment",
           x = c(0 - 0.02, min_threshold - 0.02), y = c(0.35, 0.35),
           xend = c(0 - 0.1, min_threshold - 0.1), yend = c(0.35, 0.35),
           arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
  expand_limits(y = c(0.001, 0)) +
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14)
  ) +
  theme(
    legend.key.size = unit(0.5, "cm"), # Change legend key size
    legend.key.height = unit(0.5, "cm"), # Change legend key height
    legend.key.width = unit(0.5, "cm"), # Change legend key width
    legend.title = element_text(size = 10), # Change legend title font size
    legend.text = element_text(size = 8) # Change legend text font size
  )

p_hostplantspecificity1
```


```{r}
ggsave(file.path("media", "msci_hostplantspecificity_conference.jpg"),
       p_hostplantspecificity1,
       dpi = 300,
       width = 8,
       height = 4)
```
