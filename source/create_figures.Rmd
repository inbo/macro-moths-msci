---
title: "Create figures for research paper"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
opts_knit$set(root.dir = here::here())

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
```

# Goal

Create nice figures for the research paper.

# Load data

```{r load-data}
data_path <- file.path("output", "r_objects")

msci_draw_list_log_raw <- readRDS(file.path(data_path,
                                            "msci_draw_list_log.rds"))
```

# Prepare data

```{r}
msci_draw_list_log <- lapply(msci_draw_list_log_raw, function(df) {
  df %>%
    mutate(label = paste0(trait_value, "\n", "(n = ", n_species, ")"))
  })
```

# MSCI figures
## Set general themes and functions

```{r}
index_labels <- function(x) {
  sprintf("%+.0f%%", 100 * (exp(x) - 1))
}


index_breaks <- function(x) {
  z <- 1 - c(
    9 / 10, 4 / 5, 3 / 4, 2 / 3, 1 / 2, 1 / 3, 1 / 4, 1 / 5, 1 / 10, 0
  )
  z <- log(sort(z))
  z <- z[which(z >= min(-abs(x)))[1] + -1:3]
  c(z, 0, -z)
}

minor_breaks <- function(x) {
  breaks <- unique(abs(index_breaks(x)))
  out <- vector(length = length(breaks) - 1)
  i <- 1
  while (i < length(breaks)) {
    out[i] <- mean(c(breaks[i], breaks[i + 1]))
    i <- i + 1
  }
  return(c(-out, out))
}

index_breaks_rev <- function(x) {
  exp(index_breaks(x))
}

index_labels_rev <- function(x, digits = 2) {
  format(round(exp(index_breaks(x)), digits), nsmall = digits)
}
```

```{r}
my_theme <- labs(y = "",
         x = "Multi-Species Change Index",
         fill = "Trend:") +
    theme(
      legend.position = "bottom"
    ) +
    annotate("text", label = c("increase", "strong increase"),
             x = c(0 + 0.02, max_threshold + 0.02), y = c(0.5, 0.5),
             size = 2, hjust = "left") +
    annotate("segment",
             x = c(0 + 0.02, max_threshold + 0.02), y = c(0.55, 0.55),
             xend = c(0 + 0.1, max_threshold + 0.1), yend = c(0.55, 0.55),
             arrow = arrow(type = "closed", length = unit(0.01, "npc"))) +
    annotate("text", label = c("decrease", "strong decrease"),
             x = c(0 - 0.02, min_threshold - 0.02), y = c(0.5, 0.5),
             size = 2, hjust = "right") +
    annotate("segment",
             x = c(0 - 0.02, min_threshold - 0.02), y = c(0.55, 0.55),
             xend = c(0 - 0.1, min_threshold - 0.1), yend = c(0.55, 0.55),
             arrow = arrow(type = "closed", length = unit(0.01, "npc")))
```

