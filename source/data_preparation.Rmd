---
title: "Data preparation"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
bibliography: [references.json]
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/research-institute-for-nature-and-forest.csl
---

```{r setup, include=FALSE}
# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here::here())

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)

# Packages
library(tidyverse)
```

# Goal

# Load data

We read in the data and prepare it for further processing. We select stationary and migratory species.

```{r}
data_path <- file.path("data", "raw")

# Species list
check_list_flanders <- read_delim(
    file.path(data_path, "tblChecklistFlanders.csv"),
    delim = ";") %>% 
  filter(Status == "Standvlinder" | Status == "Trekvlinder") %>% 
  select(species_nl)

# Presences
presence_data <- read_delim(
    file.path(data_path, "tblAllCondensUtm5km_v2022.csv"),
    delim = ";")
```

# Data processing

We merge the species list and presence list and count the number of occupied UTM grids per species per period. We store both a dataset with and without zero counts.

```{r}
# Join dataframes
joined_df <- left_join(check_list_flanders, presence_data, by = "species_nl")

# Number of grids per species per period
df_lang <- joined_df %>% 
  rename(Year = year,
         Species = species_nl) %>% 
  distinct(Species,
           Year,
           Utm5km) %>% 
  filter(Year >= 1980 & Year <= 2022) %>%
  mutate(period = case_when(Year >= 1980 & Year <= 2012 ~ "p1980_2012",
                            Year >= 2013 & Year <= 2022 ~ "p2013_2022")) %>% 
  distinct(Species,
           Utm5km,
           period) %>%
  group_by(period) %>%
  mutate(som_per_periode = n()) %>%
  group_by(Species, period, som_per_periode) %>% 
  summarise(n_hokken = n())

# Save number of grids
aantal_hokken <- df_lang %>%
  ungroup() %>%
  distinct(period, som_per_periode)


# Wide format
df_breed <- df_lang %>% 
  pivot_wider(id_cols = Species,
              names_from = period,
              values_from = n_hokken)

df_breed[c("p1980_2012", "p2013_2022")][is.na(df_breed[c("p1980_2012", 
                                                       "p2013_2022")])] <- 0

# Save dataframe without zeroes
df_breed_som_nul <- df_breed %>% 
  filter(p1980_2012 > 0 & p2013_2022 > 0) %>%
  mutate(sum = p1980_2012 + p2013_2022)

# Save dataframe with zeroes
df_breed_som <- df_breed %>%
  mutate(sum = p1980_2012 + p2013_2022)

head(df_breed_som, 10) %>%
  kable()
```

We calculate the relative proportion $p$ of species $i$ in period $j$ as the number of UTM grids $n$ per species ($i = 1, ..., S$) in each period ($j = 1, 2$) divided by the sum of the total number of grids per period, namely `r pull(aantal_hokken[1, 2])` in the reference period 1980-2012 ($j = 1$) and `r pull(aantal_hokken[2, 2])` in the period 2013-2022 ($j = 2$).

$$
\hat{p}_{ij} = \frac{n_{ij}}{\sum_{i=1}^S n_{ij}}
$$

```{r}
# Without zeroes
prop_df1_nul <- df_breed_som_nul %>%
  mutate(p2013_2022 = ifelse(p1980_2012 == 0 & p2013_2022 == 0, NA, 
                             p2013_2022)) %>%
  pivot_longer(cols = c(p1980_2012:p2013_2022),
               names_to = "periode",
               values_to = "n_hokken") %>%
  group_by(periode) %>%
  filter(!is.na(n_hokken)) %>%
  mutate(
    som_per_periode = sum(n_hokken),
    rel_prop = (n_hokken) / som_per_periode
    ) %>%
  ungroup() %>%
  select(soort = Species, n_hokken, periode, som_per_periode, rel_prop)

# With zeroes
prop_df1 <- df_breed_som %>%
  mutate(p2013_2022 = ifelse(p1980_2012 == 0 & p2013_2022 == 0, NA, 
                             p2013_2022)) %>%
  pivot_longer(cols = c(p1980_2012:p2013_2022),
               names_to = "periode",
               values_to = "n_hokken") %>%
  group_by(periode) %>%
  filter(!is.na(n_hokken)) %>%
  mutate(
    som_per_periode = sum(n_hokken),
    rel_prop = (n_hokken) / som_per_periode
    ) %>%
  ungroup() %>%
  select(soort = Species, n_hokken, periode, som_per_periode, rel_prop)

head(prop_df1, 10) %>%
  kable()
```
